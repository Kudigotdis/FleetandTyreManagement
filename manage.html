<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>FMIS — Manage & Report Compiler</title>
  <script src="DataManager.js"></script>
  <style>
    :root {
      --blue: #0866ff;
      --white: #ffffff;
      --grey-bg: #f4f4f4;
      --grey-mid: #e2e5e9;
      --grey-border: #ededed;
      --grey-text: #707070;
      --black: #000000;
      --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font);
      background: var(--grey-bg);
      color: var(--black);
      padding-bottom: 120px;
      overflow-x: hidden;
    }

    /* LEVEL 1: HEADER/NAVIGATION */
    header {
      background: var(--blue);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--white);
    }

    .header-top h1 {
      font-size: 18px;
      font-weight: 800;
    }

    .tab-bar {
      display: flex;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 3px;
      width: 100%;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      font-size: 14px;
      font-weight: 700;
      color: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: #002665;
      color: var(--white);
    }

    /* BOTHOflow COMPILER CARDS */
    .compiler-card {
      background: var(--white);
      margin: 12px 16px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card-trigger {
      width: 100%;
      padding: 18px;
      background: var(--white);
      border: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 16px;
      font-weight: 800;
      color: var(--black);
      cursor: pointer;
    }

    .trigger-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-btn {
      font-size: 11px;
      font-weight: 800;
      color: var(--blue);
      text-transform: uppercase;
      border: 1px solid var(--blue);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .card-body {
      display: none;
      padding: 0 0;
      border-top: 1px solid var(--grey-bg);
    }

    .card-body.open {
      display: block;
    }

    /* COMPILER ROWS */
    .compiler-row {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--grey-bg);
      cursor: pointer;
    }

    .compiler-row:active {
      background: #f8faff;
    }

    .select-btn {
      width: 28px;
      height: 28px;
      border: 2px solid var(--grey-mid);
      border-radius: 8px;
      margin-right: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .select-btn.on {
      background: var(--blue);
      border-color: var(--blue);
    }

    .select-btn.on::after {
      content: '✓';
      color: #fff;
      font-size: 16px;
      font-weight: 900;
    }

    .row-data {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .data-main {
      font-size: 14px;
      font-weight: 700;
    }

    .data-sub {
      font-size: 12px;
      color: var(--grey-text);
      font-weight: 600;
    }

    .data-meta {
      font-size: 11px;
      font-weight: 800;
      color: var(--blue);
    }

    /* OPTIONS BAR (BOTTOM OF EACH CARD) */
    .card-options {
      display: flex;
      background: var(--blue);
      padding: 12px;
    }

    .opt-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--white);
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }

    .opt-btn:not(:last-child) {
      border-right: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* NESTED DRILL DOWN (FUEL) */
    .nested-group {
      background: #fdfdfd;
      padding-left: 20px;
      display: none;
    }

    .nested-group.open {
      display: block;
    }

    /* REACTIVE BOTTOM NAV (FULL REPORT) */
    .full-report-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--black);
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px calc(0px + env(safe-area-inset-bottom));
      z-index: 2000;
      transition: transform 0.3s;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
    }

    .hamburger {
      font-size: 24px;
      color: var(--white);
      cursor: pointer;
    }

    .report-info {
      color: var(--white);
      text-align: center;
    }

    .report-count {
      font-size: 14px;
      font-weight: 800;
    }

    .report-actions {
      display: flex;
      gap: 8px;
    }

    .report-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 800;
    }

    .report-btn.compile {
      background: var(--blue);
    }

    /* MODALS */
    .modal {
      position: fixed;
      inset: 0;
      background: var(--white);
      z-index: 3000;
      display: none;
      flex-direction: column;
    }

    .modal.open {
      display: flex;
    }

    .modal-header {
      background: #ededed;
      padding: 24px 20px;
    }

    .modal-title-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 20px;
      font-weight: 800;
      outline: none;
      margin-bottom: 8px;
    }

    .modal-desc-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 14px;
      color: var(--grey-text);
      outline: none;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-footer {
      background: var(--black);
      padding: 16px;
      display: flex;
      justify-content: space-around;
    }

    .nav-hidden {
      transform: translateY(100%);
    }
  </style>
</head>

<body onscroll="handleScroll()">

  <header>
    <div class="header-top">
      <h1>FMIS Manage</h1>
      <div id="userGreeting" style="font-size:12px; font-weight:600;"></div>
    </div>
    <div class="tab-bar">
      <div class="tab" onclick="location.href='index.html'">Driver</div>
      <div class="tab active">Manage</div>
    </div>
  </header>

  <main id="compilerApp">
    <!-- LEVEL 2: VEHICLE STATUS -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('vehicles')">
        <span>Vehicle - Status</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('vehicles')">Feb 2026</span>
          <span id="arrow-vehicles">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-vehicles">
        <div id="list-vehicles"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-vehicles">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('vehicles')">Preview</div>
          <div class="opt-btn" onclick="resetCard('vehicles')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 3: FUEL ALLOCATION -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('fuel')">
        <span>Fuel Allocation</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('fleet')">Feb 2026</span>
          <span id="arrow-fuel">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-fuel">
        <div id="list-fuel"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-fuel">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('fuel')">Preview</div>
          <div class="opt-btn" onclick="resetCard('fuel')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 4: STATIONS -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('stations')">
        <span>Stations</span>
        <span id="arrow-stations">▼</span>
      </button>
      <div class="card-body" id="body-stations">
        <div id="list-stations"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-stations">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('stations')">Preview</div>
          <div class="opt-btn" onclick="resetCard('stations')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 5: TYRES -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('tyres')">
        <span>Tyres</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('tyres')">Feb 2026</span>
          <span id="arrow-tyres">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-tyres">
        <div id="list-tyres"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-tyres">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('tyres')">Preview</div>
          <div class="opt-btn" onclick="resetCard('tyres')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 6: DRIVERS -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('drivers')">
        <span>Personnel & Registry</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('drivers')">Feb 2026</span>
          <span id="arrow-drivers">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-drivers">
        <div id="list-drivers"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-drivers">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('drivers')">Preview</div>
          <div class="opt-btn" onclick="resetCard('drivers')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 7: ATTENTIONS -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('attentions')">
        <span>Attentions</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('attentions')">Feb 2026</span>
          <span id="arrow-attentions">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-attentions">
        <div id="list-attentions"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-attentions">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('attentions')">Preview</div>
          <div class="opt-btn" onclick="resetCard('attentions')">Reset</div>
        </div>
      </div>
    </div>

    <!-- LEVEL 8: FLEET VIEW -->
    <div class="compiler-card">
      <button class="card-trigger" onclick="toggleCard('fleet')">
        <span>Fleet View</span>
        <div class="trigger-right">
          <span class="month-btn" onclick="openDatePicker('fleet')">Feb 2026</span>
          <span id="arrow-fleet">▼</span>
        </div>
      </button>
      <div class="card-body" id="body-fleet">
        <div id="list-fleet"></div>
        <div class="card-options">
          <div class="opt-btn" id="count-fleet">0 Selected</div>
          <div class="opt-btn" onclick="previewMini('fleet')">Preview</div>
          <div class="opt-btn" onclick="resetCard('fleet')">Reset</div>
        </div>
      </div>
    </div>
  </main>

  <!-- LEVEL 9: FULL REPORT BAR -->
  <div class="full-report-bar" id="fullNav">
    <div class="hamburger">☰</div>
    <div class="report-info">
      <div class="report-count" id="full-total-count">0 Items Selected</div>
      <div style="font-size:10px; opacity:0.7">Full-Report Compilation</div>
    </div>
    <div class="report-actions">
      <button class="report-btn" onclick="previewFull()">Preview</button>
      <button class="report-btn compile" onclick="saveFull()">Compile</button>
    </div>
  </div>

  <!-- MINI REPORT MODAL -->
  <div class="modal" id="miniModal">
    <div class="modal-header">
      <div style="font-size:11px; color:var(--grey-text); font-weight:800; margin-bottom:4px;" id="miniMeta">20 Feb 2026
        - 10:45 AM | ID: REP-AUTO-001</div>
      <input type="text" class="modal-title-input" id="miniTitle" value="Mini-Report Title">
      <input type="text" class="modal-desc-input" id="miniDesc"
        placeholder="Add a description for this specific capture...">
    </div>
    <div class="modal-body" id="miniContent"></div>
    <div class="modal-footer">
      <button class="report-btn" onclick="closeModal('miniModal')">Cancel</button>
      <button class="report-btn" onclick="shareMini()">Share</button>
      <button class="report-btn compile" onclick="compileToFull()">Save & Compile</button>
    </div>
  </div>

  <!-- FULL REPORT MODAL -->
  <div class="modal" id="fullModal">
    <div class="modal-header">
      <input type="text" class="modal-title-input" id="fullTitle" value="Monthly Fleet Summary - Feb 2026">
      <div style="font-size:12px; color:var(--blue); font-weight:800">Final Compilation</div>
    </div>
    <div class="modal-body" id="fullContent"></div>
    <div class="modal-footer">
      <button class="report-btn" onclick="closeModal('fullModal')">Back</button>
      <button class="report-btn" onclick="shareFull()">WhatsApp</button>
      <button class="report-btn compile" onclick="confirmFullSave()">Save Final</button>
    </div>
  </div>

  <script>
    let lastScroll = 0;
    let currentUser = null;

    // Selection State: sectionKey -> Set of IDs
    const Selections = {
      vehicles: new Set(),
      fuel: new Set(),
      stations: new Set(),
      tyres: new Set(),
      drivers: new Set(),
      attentions: new Set(),
      fleet: new Set()
    };

    const CompiledMiniReports = []; // Stores { title, desc, items, type, date }

    function init() {
      const userJson = sessionStorage.getItem('fmis_user');
      if (!userJson) { location.href = 'login.html'; return; }
      currentUser = JSON.parse(userJson);
      if (currentUser.type !== 'manager' && currentUser.type !== 'admin') { location.href = 'index.html'; return; }

      document.getElementById('userGreeting').textContent = `${currentUser.first} ${currentUser.last} · ${currentUser.role}`;

      renderAllLists();
    }

    // BOTHOFLOW CARD LOGIC
    function toggleCard(id) {
      const body = document.getElementById(`body-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      const isOpen = body.classList.contains('open');

      // Smooth Bothoflow: close others
      document.querySelectorAll('.card-body').forEach(b => b.classList.remove('open'));
      document.querySelectorAll('[id^="arrow-"]').forEach(a => a.textContent = '▼');

      if (!isOpen) {
        body.classList.add('open');
        arrow.textContent = '▲';
      }
    }

    function renderAllLists() {
      renderVehicles();
      renderFuel();
      renderStations();
      renderTyres();
      renderDrivers();
      renderAttentions();
      renderFleet();
    }

    // --- RENDERING MODULES ---

    function renderVehicles() {
      const list = document.getElementById('list-vehicles');
      list.innerHTML = '';
      // In a real app, we'd filter by currentPeriod.
      const items = [
        { id: 'v-today', title: 'Daily Status', count: 8, sub: `Active in ${currentPeriod}` },
        { id: 'v-yest', title: 'Operational Log', count: 8, sub: 'Summary' }
      ];
      items.forEach(item => {
        list.appendChild(createRow('vehicles', item.id, item.title, `${item.count} Vehicles`, item.sub));
      });
    }

    function renderFuel() {
      const list = document.getElementById('list-fuel');
      list.innerHTML = '';
      const allLogs = DataManager.getFuel();
      // Filter by currentPeriod (YYYY-MM)
      const logs = allLogs.filter(l => l.date.startsWith(currentPeriod));

      const dates = [...new Set(logs.map(l => l.date))].sort().reverse();

      if (logs.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5; font-size:12px">No logs for this period</div>';
        return;
      }

      dates.forEach(date => {
        const dayLogs = logs.filter(l => l.date === date);
        const totalL = dayLogs.reduce((s, x) => s + x.litres, 0);
        const totalP = dayLogs.reduce((s, x) => s + (x.litres * x.price), 0);
        const dateId = `fuel-date-${date}`;

        const row = createRow('fuel', dateId, date,
          `${totalL.toFixed(1)}L | P${totalP.toFixed(2)} | for ${dayLogs.length} vehicles`,
          'Tap to view vehicles');

        row.onclick = (e) => {
          if (e.target.classList.contains('select-btn')) {
            toggleItem('fuel', dateId);
          } else {
            const nested = document.getElementById(`nested-${date}`);
            nested.style.display = nested.style.display === 'block' ? 'none' : 'block';
          }
        };
        list.appendChild(row);

        const nested = document.createElement('div');
        nested.id = `nested-${date}`;
        nested.className = 'nested-group';
        dayLogs.forEach(log => {
          const v = DataManager.getVehicles().find(veh => veh.id === log.vehicleId);
          const subRow = createRow('fuel', log.id, v.reg, `${log.litres}L | P${(log.litres * log.price).toFixed(2)}`, `${log.time} at ${log.station}`);
          nested.appendChild(subRow);
        });
        list.appendChild(nested);
      });
    }

    function renderStations() {
      const list = document.getElementById('list-stations');
      list.innerHTML = '';
      const stations = [
        { id: 'st-ga', name: 'Gaborone Central', vCount: 12, dCount: 15 },
        { id: 'st-fr', name: 'Francistown Depot', vCount: 8, dCount: 10 },
        { id: 'st-mo', name: 'Molepolole Works', vCount: 5, dCount: 6 }
      ];

      stations.forEach(st => {
        const id = `station-${st.id}`;
        const row = createRow('stations', id, st.name, `${st.vCount} Vehicles | ${st.dCount} Drivers`, 'Tap to expand details');

        row.onclick = (e) => {
          if (e.target.classList.contains('select-btn')) {
            toggleItem('stations', id);
          } else {
            const nested = document.getElementById(`nested-${st.id}`);
            nested.style.display = nested.style.display === 'block' ? 'none' : 'block';
          }
        };
        list.appendChild(row);

        const nested = document.createElement('div');
        nested.id = `nested-${st.id}`;
        nested.className = 'nested-group';

        // Mocking nested sub-rows for station
        const sub1 = createRow('stations', `${st.id}-v`, `${st.name} Fleet`, 'All assigned vehicles', 'Active Status');
        const sub2 = createRow('stations', `${st.id}-d`, `${st.name} Personnel`, 'All assigned drivers', 'Duty Roster');
        nested.appendChild(sub1);
        nested.appendChild(sub2);

        list.appendChild(nested);
      });
    }

    function renderTyres() {
      const list = document.getElementById('list-tyres');
      list.innerHTML = '';
      const items = [
        { id: 'ty-use', title: 'In Use', val: 32 },
        { id: 'ty-stock', title: 'In Stock', val: 14 },
        { id: 'ty-repl', title: 'Replaced (Month)', val: 4 },
        { id: 'ty-punc', title: 'Punctures', val: 2 }
      ];
      items.forEach(item => {
        list.appendChild(createRow('tyres', item.id, item.title, `${item.val} Units`, 'Tracking by Serial No.'));
      });
    }

    function renderDrivers() {
      const list = document.getElementById('list-drivers');
      list.innerHTML = '';
      const allUsers = DataManager.getUsers();

      // Categorize as requested: ALL profiles visibility
      const admins = allUsers.filter(u => u.type === 'admin');
      const managers = allUsers.filter(u => u.type === 'manager');
      const drivers = allUsers.filter(u => u.type === 'driver');

      list.appendChild(createRow('drivers', 'staff-admins', 'Admins', `${admins.length} Total`, 'System Control'));
      list.appendChild(createRow('drivers', 'staff-managers', 'Managers', `${managers.length} Total`, 'Fleet Oversight'));
      list.appendChild(createRow('drivers', 'staff-drivers', 'Drivers', `${drivers.length} Total`, 'Field Ops'));

      // Individual profiles drill down
      const nested = document.createElement('div');
      nested.className = 'nested-group';
      nested.id = 'nested-staff';
      allUsers.forEach(u => {
        nested.appendChild(createRow('drivers', u.id, `${u.first} ${u.last}`, u.role, u.area));
      });

      const allRow = createRow('drivers', 'staff-all', 'Show All Personnel', `${allUsers.length} Members`, 'Detailed Registry');
      allRow.onclick = (e) => {
        if (e.target.classList.contains('select-btn')) {
          toggleItem('drivers', 'staff-all');
        } else {
          nested.style.display = nested.style.display === 'block' ? 'none' : 'block';
        }
      };

      list.appendChild(allRow);
      list.appendChild(nested);
    }

    function renderAttentions() {
      const list = document.getElementById('list-attentions');
      list.innerHTML = '';
      const atts = DataManager.getAttentions();
      atts.forEach(a => {
        const v = DataManager.getVehicles().find(v => v.id === a.vehicleId);
        list.appendChild(createRow('attentions', a.id, `${v.reg} - ${a.type}`, a.details, a.status));
      });
    }

    function renderFleet() {
      const list = document.getElementById('list-fleet');
      list.innerHTML = '';
      const vehicles = DataManager.getVehicles();
      vehicles.forEach(v => {
        list.appendChild(createRow('fleet', v.id, v.reg, v.type, v.station));
      });
    }

    // --- CORE UI GENERATOR ---
    function createRow(secKey, id, title, sub, meta) {
      const row = document.createElement('div');
      row.className = 'compiler-row';
      row.onclick = (e) => {
        toggleItem(secKey, id);
      };

      const isSelected = Selections[secKey].has(id);

      row.innerHTML = `
      <div class="select-btn ${isSelected ? 'on' : ''}" id="btn-${id}"></div>
      <div class="row-data">
        <div class="data-main" id="title-${id}">${title}</div>
        <div class="data-sub">${sub}</div>
        <div class="data-meta">${meta}</div>
      </div>
    `;
      return row;
    }

    function toggleItem(secKey, id) {
      const set = Selections[secKey];
      const btn = document.getElementById(`btn-${id}`);

      if (set.has(id)) {
        set.delete(id);
        btn.classList.remove('on');
      } else {
        set.add(id);
        btn.classList.add('on');
      }

      updateGlobalCounters();
    }

    function updateGlobalCounters() {
      let total = 0;
      for (const key in Selections) {
        const count = Selections[key].size;
        document.getElementById(`count-${key}`).textContent = `${count} Selected`;
        total += count;
      }
      document.getElementById('full-total-count').textContent = `${total} Items Selected`;
    }

    function resetCard(key) {
      Selections[key].clear();
      renderAllLists();
      updateGlobalCounters();
    }

    // --- MINI REPORT LOGIC ---
    function previewMini(key) {
      if (Selections[key].size === 0) { alert('Select items first'); return; }

      const modal = document.getElementById('miniModal');
      const content = document.getElementById('miniContent');
      const selectedIds = Array.from(Selections[key]);

      // Fetch data for these IDs (simplified for demo)
      let html = `<h3>${key.toUpperCase()} Line Items</h3><ul style="padding-left:20px; margin-top:12px">`;
      selectedIds.forEach(id => {
        const titleEl = document.getElementById(`title-${id}`);
        html += `<li style="margin-bottom:8px; font-size:14px"><b>${titleEl ? titleEl.textContent : id}</b></li>`;
      });
      html += `</ul>`;

      content.innerHTML = html;
      document.getElementById('miniTitle').value = `${key.charAt(0).toUpperCase() + key.slice(1)} Summary`;
      document.getElementById('miniMeta').textContent = `${new Date().toLocaleDateString()} | ID: REP-${key.toUpperCase()}-${Math.floor(Math.random() * 900)}`;

      modal.classList.add('open');
      modal.dataset.currentSection = key;
    }

    function compileToFull() {
      const key = document.getElementById('miniModal').dataset.currentSection;
      const report = {
        title: document.getElementById('miniTitle').value,
        desc: document.getElementById('miniDesc').value,
        items: Array.from(Selections[key]),
        section: key,
        date: new Date().toLocaleString()
      };

      CompiledMiniReports.push(report);
      alert('Mini-Report added to Full-Report Compiler.');
      closeModal('miniModal');
      resetCard(key);
    }

    // --- FULL REPORT LOGIC ---
    function saveFull() {
      if (CompiledMiniReports.length === 0) { alert('Compile at least one Mini-Report first'); return; }
      previewFull();
    }

    function previewFull() {
      const modal = document.getElementById('fullModal');
      const content = document.getElementById('fullContent');

      let html = '';
      CompiledMiniReports.forEach((rep, idx) => {
        html += `
        <div style="background:#f8f9fa; border-radius:12px; padding:16px; margin-bottom:12px; border-left:4px solid var(--blue); position:relative">
           <div style="font-weight:800; font-size:15px">${rep.title}</div>
           <div style="font-size:11px; color:var(--grey-text); margin:4px 0">${rep.date} · ${rep.items.length} Points</div>
           <div style="font-size:13px">${rep.desc}</div>
           <button onclick="removeMini(${idx})" style="position:absolute; top:12px; right:12px; background:none; border:none; color:red; font-size:10px; font-weight:800">REMOVE</button>
        </div>
      `;
      });

      content.innerHTML = html;
      modal.classList.add('open');
    }

    function removeMini(idx) {
      if (confirm('Delete this Mini-Report?')) {
        CompiledMiniReports.splice(idx, 1);
        if (CompiledMiniReports.length === 0) closeModal('fullModal');
        else previewFull();
      }
    }

    function shareFull() {
      const title = document.getElementById('fullTitle').value;
      let text = `*FMIS FULL REPORT: ${title}*\n\n`;
      CompiledMiniReports.forEach(r => {
        text += `[${r.title}]\n - Points: ${r.items.join(', ')}\n - ${r.desc}\n\n`;
      });
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    function confirmFullSave() {
      const title = document.getElementById('fullTitle').value;
      DataManager.saveReport({
        title,
        reports: CompiledMiniReports,
        date: new Date().toISOString()
      });
      alert('Full Report Saved to Profile -> Reports.');
      closeModal('fullModal');
      // Clear everything
      CompiledMiniReports.length = 0;
    }

    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    function handleScroll() {
      const st = window.pageYOffset || document.documentElement.scrollTop;
      const nav = document.getElementById('fullNav');
      if (st > lastScroll && st > 100) { nav.classList.add('nav-hidden'); }
      else { nav.classList.remove('nav-hidden'); }
      lastScroll = st <= 0 ? 0 : st;
    }

    function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

    window.onload = init;
  </script>
</body>

</html>